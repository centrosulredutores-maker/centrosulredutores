<script>
        // COLE AQUI A URL QUE VOCÊ COPIOU DO GOOGLE APPS SCRIPT
        const API_URL = "https://script.google.com/macros/s/AKfycbyglnVckXYFS9QlZ5Dp1UptGcL7v0MTpHG0j21DhOi2zq8DfTdIRwE48YIr_mHkVZMHLw/exec";

        // Variável local apenas para cache visual, o real vem da planilha
        let dbOS = []; 

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            
            if(params.get('mode') === 'client') {
                document.body.classList.add('client-mode');
                mudarAba('portal');
            } 
            else if(params.has('view')) {
                document.body.classList.add('client-mode');
                carregarOSPorURL(params);
            }
            else {
                // Modo Admin: Carrega dados da planilha ao iniciar
                atualizarTabelaAdmin();
                
                // Define data de hoje
                document.getElementById('data_entrada').valueAsDate = new Date();
                
                // Gera um ID aleatório ou sequencial simples baseado no tempo para não repetir
                document.getElementById('os_num').value = Math.floor(Date.now() / 1000).toString().slice(-6);
            }
        };

        function mudarAba(aba) {
            document.querySelectorAll('.tab-content, .nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + aba).classList.add('active');
            if(document.getElementById('btn-' + aba)) document.getElementById('btn-' + aba).classList.add('active');
        }

        function salvarOS() {
            const btn = document.querySelector('.btn-fab');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
            btn.disabled = true;

            const os = {
                id: document.getElementById('os_num').value,
                cliente: document.getElementById('cliente').value,
                cnpj: document.getElementById('cnpj').value,
                equipamento: document.getElementById('equipamento').value,
                modelo: document.getElementById('modelo').value,
                servico: document.getElementById('servico').value,
                data_entrada: document.getElementById('data_entrada').value,
                data_saida: document.getElementById('data_saida').value
            };

            // Envia para o Google Sheets
            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors', // Importante para enviar dados para o Google
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(os)
            }).then(() => {
                alert("OS Salva na Nuvem com Sucesso!");
                btn.innerHTML = originalText;
                btn.disabled = false;
                gerarQRCode(os);
                atualizarTabelaAdmin(); // Recarrega a lista
            }).catch(err => {
                alert("Erro ao salvar: " + err);
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        async function atualizarTabelaAdmin() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                dbOS = data; // Atualiza base local
                renderizarTabela(data);
            } catch (error) {
                console.error("Erro ao carregar dados", error);
            }
        }

        async function consultarOS() {
            const cod = document.getElementById('input_codigo_cliente').value;
            const btn = document.querySelector('.search-box button');
            
            if(!cod) return alert("Digite um código.");

            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> BUSCANDO...';
            
            try {
                // Busca diretamente na planilha pelo ID
                const response = await fetch(API_URL + "?buscaId=" + cod);
                const os = await response.json();

                if(os) {
                    const datas = JSON.parse(os.datas);
                    const params = new URLSearchParams({
                        view: 1, i: os.id, c: os.cliente, cp: os.cnpj, e: os.equipamento, m: os.modelo, s: os.servico, de: datas.entrada, ds: datas.saida
                    });
                    window.location.href = window.location.origin + window.location.pathname + '?' + params.toString();
                } else {
                    alert("OS não encontrada na base de dados.");
                }
            } catch (error) {
                alert("Erro ao buscar. Verifique sua conexão.");
            } finally {
                btn.innerHTML = '<i class="fas fa-search"></i> CONSULTAR SERVIÇO';
            }
        }

        // --- FUNÇÕES QUE JÁ EXISTIAM MANTIDAS IGUAIS ---

        function copiarLinkPortal() {
            const link = window.location.origin + window.location.pathname + '?mode=client';
            navigator.clipboard.writeText(link);
            alert("Link copiado!");
        }

        function carregarOSPorURL(params) {
            mudarAba('nova-os');
            document.getElementById('os_num').value = params.get('i');
            document.getElementById('cliente').value = params.get('c');
            document.getElementById('cnpj').value = params.get('cp');
            document.getElementById('equipamento').value = params.get('e');
            document.getElementById('modelo').value = params.get('m');
            document.getElementById('servico').value = params.get('s');
            document.getElementById('data_entrada').value = params.get('de');
            document.getElementById('data_saida').value = params.get('ds');
            document.querySelectorAll('input, textarea').forEach(el => el.readOnly = true);
        }

        function copiarLinkOSAtual() {
            navigator.clipboard.writeText(window.location.href);
            alert("Link desta OS copiado!");
        }

        function gerarQRCode(os) {
            document.getElementById("qrcode").innerHTML = "";
            const params = new URLSearchParams({
                view: 1, i: os.id, c: os.cliente, cp: os.cnpj, e: os.equipamento, m: os.modelo, s: os.servico, de: os.data_entrada, ds: os.data_saida
            });
            new QRCode(document.getElementById("qrcode"), {
                text: window.location.origin + window.location.pathname + '?' + params.toString(),
                width: 100, height: 100
            });
        }

        function renderizarTabela(lista) {
            const tbody = document.getElementById('lista-os');
            tbody.innerHTML = lista.slice().reverse().map(os => `
                <tr>
                    <td>#${os.id}</td>
                    <td>${os.cliente}</td>
                    <td>${os.equipamento}</td>
                    <td>
                        <button class="nav-btn" style="color:var(--accent)" onclick="carregarOSAdmin('${os.id}')"><i class="fas fa-edit"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function carregarOSAdmin(id) {
            const os = dbOS.find(x => x.id == id);
            if(!os) return;
            
            const datas = JSON.parse(os.datas); // Parse das datas vindas do Google
            
            document.getElementById('os_num').value = os.id;
            document.getElementById('cliente').value = os.cliente;
            document.getElementById('cnpj').value = os.cnpj;
            document.getElementById('equipamento').value = os.equipamento;
            document.getElementById('modelo').value = os.modelo;
            document.getElementById('servico').value = os.servico;
            document.getElementById('data_entrada').value = datas.entrada;
            document.getElementById('data_saida').value = datas.saida;
            
            // Ajusta o objeto para o QR Code funcionar
            const osParaQR = {...os, data_entrada: datas.entrada, data_saida: datas.saida};
            gerarQRCode(osParaQR);
            mudarAba('nova-os');
        }
    </script>