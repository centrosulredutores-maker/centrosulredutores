<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centrosul | Portal de Serviço</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #00dc82;
            --secondary: #0f172a;
            --danger: #ef4444;
            --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --text-main: #1e293b;
            --text-light: #64748b;
            --radius-lg: 16px;
            --radius-md: 12px;
            --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; transition: all 0.2s ease; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; background: var(--bg-gradient); min-height: 100vh; }

        /* TRAVAS DE VISUALIZAÇÃO */
        body.client-mode .admin-only, body.client-mode .navbar { display: none !important; }
        .client-header { display: none; background: var(--secondary); color: white; padding: 15px; text-align: center; font-weight: bold; }
        body.client-mode .client-header { display: block; }

        /* NAVBAR */
        .navbar { background: var(--secondary); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .nav-brand { color: white; font-weight: 800; font-size: 1.2rem; }
        .nav-brand span { color: var(--primary); }
        .nav-links { display: flex; gap: 10px; }
        
        .nav-btn { background: rgba(255,255,255,0.1); color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 13px; }
        .nav-btn.active { background: var(--primary); color: var(--secondary); font-weight: bold; }

        /* PORTAL DE BUSCA */
        .portal-card { max-width: 450px; margin: 80px auto; padding: 40px; background: white; border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); text-align: center; }
        .search-box { margin-top: 25px; display: flex; flex-direction: column; gap: 15px; }
        .search-box input { font-size: 32px; text-align: center; padding: 15px; border: 2px solid #ddd; border-radius: 12px; font-weight: 800; color: var(--secondary); }
        .search-box input:focus { border-color: var(--primary); outline: none; }

        /* FOLHA DA OS */
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        .folha-a4 { background: white; max-width: 850px; margin: 0 auto; padding: 40px; border-radius: 8px; box-shadow: var(--shadow-lg); position: relative; }
        
        .os-header { display: flex; justify-content: space-between; border-bottom: 2px solid var(--secondary); padding-bottom: 20px; margin-bottom: 20px; }
        .os-number-box { background: var(--secondary); color: white; padding: 10px 20px; border-radius: 8px; text-align: center; }
        .os-number-box input { background: transparent; border: none; color: var(--primary); font-size: 20px; font-weight: 800; width: 60px; text-align: center; outline: none; }

        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .col-2 { grid-column: span 2; }
        .col-4 { grid-column: span 4; }
        
        label { display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--text-light); margin-bottom: 5px; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; background: #f8fafc; font-size: 14px; }
        input[readonly], textarea[readonly] { background: transparent; border-color: transparent; font-weight: 600; padding-left: 0; }

        /* BOTÕES */
        .btn-main { background: var(--primary); color: var(--secondary); border: none; padding: 15px; border-radius: 10px; font-weight: 800; cursor: pointer; width: 100%; }
        .client-actions { display: none; justify-content: center; gap: 15px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; }
        body.client-mode .client-actions { display: flex; }

        .btn-action { padding: 12px 20px; border-radius: 50px; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        
        /* TABELA HISTÓRICO */
        .history-container { max-width: 900px; margin: 0 auto; background: white; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow-lg); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f5f9; padding: 15px; text-align: left; font-size: 12px; color: var(--text-light); }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
        .btn-del { color: var(--danger); cursor: pointer; border: none; background: none; font-size: 18px; }

        @media print {
            .navbar, .no-print, .admin-only { display: none !important; }
            .folha-a4 { box-shadow: none; border: none; padding: 0; }
        }
    </style>
</head>
<body>

    <div class="client-header">CENTROSUL | CONSULTA DE EQUIPAMENTO</div>

    <nav class="navbar no-print">
        <div class="nav-brand">CENTROSUL <span>GESTOR</span></div>
        <div class="nav-links">
            <button class="nav-btn" onclick="copiarLinkPortal()" style="background: #25d366; color: white;">
                <i class="fas fa-link"></i> LINK DO PORTAL
            </button>
            <button id="btn-portal" class="nav-btn" onclick="mudarAba('portal')">Portal Cliente</button>
            <button id="btn-nova-os" class="nav-btn active" onclick="mudarAba('nova-os')">Nova OS</button>
            <button id="btn-historico" class="nav-btn" onclick="mudarAba('historico')">Histórico</button>
        </div>
    </nav>

    <div id="tab-portal" class="tab-content">
        <div class="portal-card">
            <i class="fas fa-search-location" style="font-size: 50px; color: var(--primary);"></i>
            <h2>Consultar OS</h2>
            <p>Digite o número da OS gravado no seu redutor.</p>
            <div class="search-box">
                <input type="number" id="input_busca" placeholder="000">
                <button class="btn-main" onclick="buscarOS()">CONSULTAR AGORA</button>
            </div>
            <p class="admin-only" style="font-size: 11px; color: orange; margin-top: 20px;">
                <i class="fas fa-exclamation-triangle"></i> Nota: A busca por código funciona apenas no navegador onde a OS foi criada. Para o cliente, envie o link direto.
            </p>
        </div>
    </div>

    <div id="tab-nova-os" class="tab-content active">
        <div class="folha-a4">
            <div class="os-header">
                <img src="https://via.placeholder.com/150x60?text=CENTROSUL" style="height: 60px;">
                <div class="os-number-box">
                    <label style="color: white; margin-bottom: 2px;">Nº ORDEM</label>
                    <input type="number" id="os_num">
                </div>
            </div>

            <form id="form-os">
                <div class="grid">
                    <div class="col-2"><label>Cliente</label><input type="text" id="cliente"></div>
                    <div class="col-2"><label>CNPJ/CPF</label><input type="text" id="cnpj"></div>
                    <div class="col-2"><label>Equipamento</label><input type="text" id="equipamento"></div>
                    <div class="col-2"><label>Modelo / Série</label><input type="text" id="modelo"></div>
                    <div class="col-4"><label>Relatório Técnico do Serviço</label><textarea id="servico" rows="8"></textarea></div>
                    <div class="col-2"><label>Data Entrada</label><input type="date" id="data_entrada"></div>
                    <div class="col-2"><label>Data Entrega</label><input type="date" id="data_saida"></div>
                </div>
            </form>

            <div id="qr-area" class="admin-only" style="display: flex; align-items: center; gap: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                <div id="qrcode"></div>
                <div>
                    <strong>Acesso Rápido do Cliente</strong><br>
                    <small>Gere o QR Code após salvar para o cliente consultar.</small>
                </div>
            </div>

            <div class="client-actions no-print">
                <button class="btn-action" style="background: var(--secondary); color: white;" onclick="window.print()">
                    <i class="fas fa-file-pdf"></i> SALVAR OS (PDF)
                </button>
                <button class="btn-action" style="background: var(--primary); color: var(--secondary);" onclick="copiarLinkPagina()">
                    <i class="fas fa-copy"></i> COPIAR LINK DA PÁGINA
                </button>
            </div>
        </div>

        <div class="admin-only no-print" style="position: fixed; bottom: 30px; right: 30px; display: flex; gap: 10px;">
            <button class="btn-action" style="background: var(--primary); box-shadow: 0 4px 15px rgba(0,220,130,0.4);" onclick="salvarOS()">
                <i class="fas fa-save"></i> SALVAR OS
            </button>
        </div>
    </div>

    <div id="tab-historico" class="tab-content admin-only">
        <div class="history-container">
            <table>
                <thead>
                    <tr><th>Nº OS</th><th>Cliente</th><th>Equipamento</th><th>Ações</th></tr>
                </thead>
                <tbody id="lista-os"></tbody>
            </table>
        </div>
    </div>

    <script>
        let dbOS = JSON.parse(localStorage.getItem('cs_db') || '[]');
        let proxCodigo = parseInt(localStorage.getItem('cs_seq') || '1');

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            
            if(params.has('view')) {
                document.body.classList.add('client-mode');
                carregarModoLeitura(params);
            } else if(params.get('mode') === 'portal') {
                document.body.classList.add('client-mode');
                mudarAba('portal');
            } else {
                document.getElementById('os_num').value = proxCodigo;
                document.getElementById('data_entrada').valueAsDate = new Date();
            }
        };

        function salvarOS() {
            const os = {
                id: document.getElementById('os_num').value,
                cliente: document.getElementById('cliente').value,
                cnpj: document.getElementById('cnpj').value,
                equipamento: document.getElementById('equipamento').value,
                modelo: document.getElementById('modelo').value,
                servico: document.getElementById('servico').value,
                data_entrada: document.getElementById('data_entrada').value,
                data_saida: document.getElementById('data_saida').value
            };

            if(!os.id || !os.cliente) return alert("Preencha o número da OS e o Cliente!");

            const index = dbOS.findIndex(x => x.id == os.id);
            if(index !== -1) dbOS[index] = os; else dbOS.push(os);
            
            if(parseInt(os.id) >= proxCodigo) proxCodigo = parseInt(os.id) + 1;
            
            localStorage.setItem('cs_db', JSON.stringify(dbOS));
            localStorage.setItem('cs_seq', proxCodigo);
            
            gerarQR(os);
            alert("Ordem de Serviço #" + os.id + " salva!");
        }

        function buscarOS() {
            const busca = document.getElementById('input_busca').value;
            const os = dbOS.find(x => x.id == busca);

            if(os) {
                const link = gerarURL(os);
                window.location.href = link;
            } else {
                alert("OS não encontrada neste dispositivo. Use o link direto enviado pelo técnico.");
            }
        }

        function gerarURL(os) {
            const p = new URLSearchParams({
                view: 1, i: os.id, c: os.cliente, cp: os.cnpj, e: os.equipamento, m: os.modelo, s: os.servico, de: os.data_entrada, ds: os.data_saida
            });
            return window.location.origin + window.location.pathname + '?' + p.toString();
        }

        function gerarQR(os) {
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById('qrcode'), { text: gerarURL(os), width: 100, height: 100 });
        }

        function carregarModoLeitura(p) {
            mudarAba('nova-os');
            document.getElementById('os_num').value = p.get('i');
            document.getElementById('cliente').value = p.get('c');
            document.getElementById('cnpj').value = p.get('cp');
            document.getElementById('equipamento').value = p.get('e');
            document.getElementById('modelo').value = p.get('m');
            document.getElementById('servico').value = p.get('s');
            document.getElementById('data_entrada').value = p.get('de');
            document.getElementById('data_saida').value = p.get('ds');
            document.querySelectorAll('input, textarea').forEach(el => el.readOnly = true);
        }

        function copiarLinkPortal() {
            const link = window.location.origin + window.location.pathname + '?mode=portal';
            navigator.clipboard.writeText(link);
            alert("Link do Portal Copiado! Envie este link para o cliente consultar via código.");
        }

        function copiarLinkPagina() {
            navigator.clipboard.writeText(window.location.href);
            alert("Link desta OS copiado!");
        }

        function mudarAba(aba) {
            document.querySelectorAll('.tab-content, .nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + aba).classList.add('active');
            if(document.getElementById('btn-' + aba)) document.getElementById('btn-' + aba).classList.add('active');
            if(aba === 'historico') renderizarTabela();
        }

        function renderizarTabela() {
            const html = dbOS.slice().reverse().map(os => `
                <tr>
                    <td><b>#${os.id}</b></td>
                    <td>${os.cliente}</td>
                    <td>${os.equipamento}</td>
                    <td>
                        <button class="btn-del" onclick="excluirOS('${os.id}')"><i class="fas fa-trash-alt"></i></button>
                        <button class="nav-btn" onclick="editarOS('${os.id}')"><i class="fas fa-edit"></i></button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('lista-os').innerHTML = html;
        }

        function excluirOS(id) {
            if(confirm("Excluir a OS #" + id + "?")) {
                dbOS = dbOS.filter(x => x.id != id);
                localStorage.setItem('cs_db', JSON.stringify(dbOS));
                renderizarTabela();
            }
        }

        function editarOS(id) {
            const os = dbOS.find(x => x.id == id);
            document.getElementById('os_num').value = os.id;
            document.getElementById('cliente').value = os.cliente;
            document.getElementById('cnpj').value = os.cnpj;
            document.getElementById('equipamento').value = os.equipamento;
            document.getElementById('modelo').value = os.modelo;
            document.getElementById('servico').value = os.servico;
            document.getElementById('data_entrada').value = os.data_entrada;
            document.getElementById('data_saida').value = os.data_saida;
            mudarAba('nova-os');
        }
    </script>
</body>
</html>